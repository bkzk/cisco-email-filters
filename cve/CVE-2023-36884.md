# CVE-2023-36884

This message filter detects known malicious RTF document embedded in OOXML documents. 

```
## Looks for specific malicious RTF document (afchunk.rtf) in OOXML by CRC or name
CVE-2023-36884: if 
(
    (attachment-filename == "(?i)\\.(xls|doc|ppt|xlsx|xlsm|xltm|xlsb|docx|docm|dotm|pptx|ppam|pptm|potm|ppsm)$")
    AND
    ( 
        (attachment-binary-contains("(\\x7e\\x33\\x28\\x0a|\\x48\\xce\\xf3\\x82)([\\x00-\\xff]{4})\\x72\\xac\\x00(.+?)\\x2e\\x72\\x74\x66"))
        OR
        (attachment-binary-contains("(word|xl|ppt)/afchunk.rtf"))
    )
)
{
    #log-entry("CVE-2023-36884: Found malicious RTF (by CRC/filename): '$MatchedContent'");
    log-entry("CVE-2023-36884: Found malicious RTF (by CRC/filename)");
    insert-header("X-CVE-2023-36884","True");
}
```

The filter looks for known embedded `afchunk.rtf` found in the following samples first analyzed by [BlacBerry](https://blogs.blackberry.com/en/2023/07/romcom-targets-ukraine-nato-membership-talks-at-nato-summit) team and later described on the [MS blog post](https://www.microsoft.com/en-us/security/blog/2023/07/11/storm-0978-attacks-reveal-financial-and-espionage-motives/).


```
3a3138c5add59d2172ad33bc6761f2f82ba344f3d03a2269c623f22c1a35df97  Letter_NATO_Summit_Vilnius_2023_ENG.doc
a61b2eafcf39715031357df6b01e85e0d1ea2e8ee1dfec241b114e18f7a1163f  Overview_of_UWCs_UkraineInNATO_campaign.docx
```

__Update__:  17 Jul 2023: Tested and updated with 5 samples. 

```
pcregrep -Moal   '(\x7e\x33\x28\x0a|\x48\xce\xf3\x82)([\x00-\xff]{4})\x72\xac\x00(.+?)\x2e\x72\x74\x66' samples/*             
samples/3a3138c5add59d2172ad33bc6761f2f82ba344f3d03a2269c623f22c1a35df97
samples/5f40cb4852ec50ee24f3cd951a172c725d02012d17dd645b6ce22d324aa140ad
samples/8f7bf913adaf425b5f6af1416220c5b8d806f3cdbcc7678deb1e800913cf3e2b
samples/a61b2eafcf39715031357df6b01e85e0d1ea2e8ee1dfec241b114e18f7a1163f
samples/b3eda654620d603d70118ba4fbc623e717c909218aaadd2c12d980692a7697df
```



__Note:__ The filter can look for patterns only on the 'zip' file as it is as Cisco ESA Message Filters does not unpack files. This is done by AV software. So this filter looks for the CRC value in the ZIP headers of the specific malicious RTF document. The name of the document may change but as long as its content is not modyfied the CRC will remain the same. The detection is limitted to known files. 


In addition to this we should consider any OOXML file embedding RTF document as suspicious. The following filter should do the job. 


```
## Looks for any embedded RTF document in OOXML
RTFinOOXML: if 
(
    attachment-filename == "(?i)\\.(xls|doc|ppt|xlsx|xlsm|xltm|xlsb|docx|docm|dotm|pptx|ppam|pptm|potm|ppsm)$" 
    AND 
    attachment-binary-contains("(word|xl|ppt)/(.+?).rtf")
)
{
    log-entry("RTFinOOXML: Found embedded RTF - Suspicious");
}
```

Filters in action:

```
 Fri Jul 14 11:26:50 2023 Info: MID 142314 attachment 'file.docx'
 Fri Jul 14 11:26:50 2023 Info: ICID 2633 close
 Fri Jul 14 11:26:50 2023 Info: MID 142314 Custom Log Entry: CVE-2023-36884: Found malicious RTF (by CRC/filename)
 Fri Jul 14 11:26:50 2023 Info: MID 142314 Custom Log Entry: RTFinOOXML: Found embedded RTF - Suspicious
 Fri Jul 14 11:26:50 2023 Info: MID 142314 matched all recipients for per-recipient policy DEFAULT in the inbound table
 Fri Jul 14 11:26:51 2023 Info: MID 142314 interim verdict using engine: CASE spam negative
 Fri Jul 14 11:26:51 2023 Info: MID 142314 using engine: CASE spam negative
 Fri Jul 14 11:26:51 2023 Info: MID 142314 interim AV verdict using McAfee CLEAN
 Fri Jul 14 11:26:52 2023 Info: MID 142314 interim AV verdict using Sophos VIRAL
 Fri Jul 14 11:26:52 2023 Info: MID 142314 antivirus positive 'CXmail/RTF-D', 'CXmail/RTF-H', 'Troj/DocDrop-TJ' 
 Fri Jul 14 11:26:52 2023 Info: MID 142314 AMP file reputation verdict : MALWARE
 Fri Jul 14 11:26:52 2023 Info: MID 142314 enqueued for transfer to centralized quarantine "Virus" (a/v verdict VIRAL)
 Fri Jul 14 11:26:52 2023 Info: MID 142314 queued for delivery
```



