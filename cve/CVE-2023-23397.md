# CVE-2023-23397


This message filter implements ClamAV (Win.Malware.CVE_2023_23397-9993083-0) rule published by TALOS. 


Copy of ClamAV rule: 

```
Win.Malware.CVE_2023_23397-9993083-0;Engine:81-255,FileSize:0-100000,Target:0;((0&1)|2)&3&(4|5)&6 ;0:D0CF11E0A1B11AE1;0B0D020000000000C000000000000046;0:789F3E22;001f8500;00005c5c;00005c005c00;00000385
```

To install this filter SSH to Cisco ESA using an administrative account and run: __FILTERS > NEW__ and paste the below filter. The order of the rule can be changed using FILTERS > MOVE. 


```
CVE-2023-23397: if(attachment-size < 100k and recv-listener == "IncomingMail") {
    if ((attachment-binary-contains("^\\xD0\\xCF\\x11\\xE0\\xA1\\xB1\\x1A\\xE1")
        and attachment-binary-contains('\\x0B\\x0D\\x02\\x00\\x00\\x00\\x00\\x00\\xC0\\x00\\x00\\x00\\x00\\x00\\x00\\x46')) 
        or attachment-binary-contains("^\\x78\\x9F\\x3E\\x22")) {
        # PidLidReminderFileParameter AND UNC path prefix - narrow + wide formatted 
        if (attachment-binary-contains('\\x1F\\x85\\x00\\x00') and attachment-binary-contains('\\x00\\x00\\x5C(\\x00)?\\x5C(\\x00)?')){
            log-entry("CVE-2023-23397: Found CLSID in OLE or TNEF.");
            log-entry("CVE-2023-23397: Found PidLidReminderFileParameter and UNC path indicators");
            # set action here
            insert-header("X-CVE-2023-23397", "True");
            strip-header ('Subject');
            insert-header ('Subject', '*** WARNING: Highly Suspicious Attachment *** $Subject');
            # Comment/Uncomment to Quarantine the message 
            quarantine('Policy');
        }
    }
}
.
```

This is an optimized version written with a single if statement. ESA should evaluate it faster but the logic might be harder to read by humans.

```
CVE-2023-23397: if 
(
    (attachment-size < 102400) 
    AND 
    (recv-listener == "IncomingMail")
) 
AND
(
    (
        (
            (attachment-binary-contains("^\\xD0\\xCF\\x11\\xE0\\xA1\\xB1\\x1A\\xE1")) 
            AND 
            (attachment-binary-contains("\\x0B\\x0D\\x02\\x00\\x00\\x00\\x00\\x00\\xC0\\x00\\x00\\x00\\x00\\x00\\x00\\x46"))
        ) 
        OR 
        (attachment-binary-contains("^\\x78\\x9F\\x3E\\x22"))      
    ) 
    AND 
    (
        (attachment-binary-contains("\\x1F\\x85\\x00\\x00")) 
        AND 
        (attachment-binary-contains("\\x00\\x00\\x5C(\\x00)?\\x5C(\\x00)?"))
    ) 
)
{
    log-entry("CVE-2023-23397: Found CLSID in OLE or TNEF.");
    log-entry("CVE-2023-23397: Found PidLidReminderFileParameter and UNC path indicators");
    insert-header("X-CVE-2023-23397", "True");
    strip-header("Subject");
    insert-header("Subject", "*** WARNING: Highly Suspicious Attachment *** $Subject");
    # Comment/Uncomment to Quarantine the message 
    quarantine("Policy");
}
.
```

Comment/Uncomment action that suits your needs the most. 

The default actions are:
- insert extra log entries (mail_logs)
- insert a custom header: X-CVE-2023-23397: True
- alter the Subject of the message
- move the message to Policy quarantine


__NOTE__: The filter execution is limitted to attachments lower than 100k and the listener name called "IncomingMail". Please remember to __REPLACE__ the listener name with the one used by your configuration. 

Example: 

```log
 Mon Mar 20 14:11:10 2023 Info: MID 141251 attachment '0db4.msg'
 Mon Mar 20 14:11:11 2023 Info: ICID 1580 close
 Mon Mar 20 14:11:11 2023 Info: MID 141251 Custom Log Entry: CVE-2023-23397: Found CLSID in OLE or TNEF.
 Mon Mar 20 14:11:11 2023 Info: MID 141251 Custom Log Entry: CVE-2023-23397: Found PidLidReminderFileParameter and UNC path indicators
 Mon Mar 20 14:11:11 2023 Info: MID 141251 matched all recipients for per-recipient policy TAC in the inbound table
 Mon Mar 20 14:11:11 2023 Info: MID 141251 interim verdict using engine: CASE spam negative
 Mon Mar 20 14:11:11 2023 Info: MID 141251 using engine: CASE spam negative
 Mon Mar 20 14:11:11 2023 Info: MID 141251 interim AV verdict using McAfee CLEAN
 Mon Mar 20 14:11:11 2023 Info: MID 141251 interim AV verdict using Sophos CLEAN
 Mon Mar 20 14:11:11 2023 Info: MID 141251 antivirus negative 
 Mon Mar 20 14:11:11 2023 Info: MID 141251 AMP file reputation verdict : MALWARE
 Mon Mar 20 14:11:11 2023 Info: MID 141251 Outbreak Filters: verdict negative
 Mon Mar 20 14:11:11 2023 Info: MID 141251 enqueued for transfer to centralized quarantine "Policy" (message filter CVE-2023-23397)
 Mon Mar 20 14:11:11 2023 Info: MID 141251 queued for delivery
``` 


Ref:
- https://blog.talosintelligence.com/outlook-privilege-escalation-vulnerability-cve-2023-23397/
